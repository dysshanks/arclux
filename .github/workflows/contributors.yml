name: Update Contributors List

permissions:
  contents: write

on:
  push:

jobs:
  update-contributors:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure docs directory exists
        run: mkdir -p docs

      - name: Install GitHub CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          curl -sSL https://github.com/cli/cli/releases/download/v2.56.0/gh_2.56.0_linux_amd64.tar.gz \
            | tar xz
          sudo mv gh_2.56.0_linux_amd64/bin/gh /usr/local/bin/gh

      - name: Generate contributors list (including PR authors and co-authors)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -d docs ]; then
            echo "directory not found!"
            exit 1
          fi

          echo "# Project Contributors" > docs/CONTRIBUTORS
          echo "" >> docs/CONTRIBUTORS

          git log --all --pretty=format:"%an|%ai" -- . ':(exclude).github/workflows' \
          | awk -F'|' '!seen[$1]++ {print $2 "|" $1}' > contributors_raw.txt

          git log --pretty=format:"%b" \
          | grep -i "Co-authored-by:" \
          | sed -E 's/Co-authored-by:\s*([^<]+).*/\1/' \
          | awk '!seen[$0]++ {print "2000-01-01 00:00:00|" $0}' >> contributors_raw.txt

          gh pr list --state all --json author,createdAt \
            | jq -r '.[] | "\(.createdAt)|\(.author.login)"' >> contributors_raw.txt

          sort contributors_raw.txt \
          | awk -F'|' '!seen[$2]++ {print $2 "|" $1}' \
          | while IFS='|' read -r author date; do
              formatted_date=$(date -d "$date" +"%b %d, %Y" 2>/dev/null || echo "$date")
              echo "- $author ($formatted_date)" >> docs/CONTRIBUTORS
            done

          echo "" >> docs/CONTRIBUTORS
          echo "_Automatically generated by GitHub Actions_" >> docs/CONTRIBUTORS
          rm -f contributors_raw.txt

      - name: Commit and push changes
        run: |
          if [[ -n "$(git status --porcelain docs/CONTRIBUTORS)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add docs/CONTRIBUTORS
            git commit -m "chore: update contributors list [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi
